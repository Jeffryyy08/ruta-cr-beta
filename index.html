<!DOCTYPE html>
<html>
<head>
  <title>Bus en Ruta - Tiempo Real</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f4f6f9;
    }

    .container {
      display: flex;
      height: 100vh;
    }

    #map {
      flex: 3;
    }

    .sidebar {
      flex: 1;
      background: white;
      padding: 20px;
      box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    }

    .sidebar h2 {
      margin-top: 0;
    }

    .info-box {
      background: #f1f5f9;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .status {
      font-weight: bold;
      color: green;
    }
  </style>
</head>
<body>

<div class="container">
  <div id="map"></div>

  <div class="sidebar">
    <h2>ðŸšŒ Bus CQ - Pital</h2>

    <div class="info-box">
      <strong>Estado:</strong>
      <div id="status" class="status">Esperando ubicaciÃ³n...</div>
    </div>

    <div class="info-box">
      <strong>Latitud:</strong>
      <div id="lat">-</div>
    </div>

    <div class="info-box">
      <strong>Longitud:</strong>
      <div id="lng">-</div>
    </div>

    <div class="info-box">
      <strong>Ãšltima actualizaciÃ³n:</strong>
      <div id="time">-</div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
  const SUPABASE_URL = "https://sljzxaenmwujgjingqst.supabase.co"
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNsanp4YWVubXd1amdqaW5ncXN0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNDI0MjMsImV4cCI6MjA4NjkxODQyM30.WdvJ95O5SHA5P85oSZMlmqEWbsCbl8Li6u4ctqgs9ho"

  const supabaseClient = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  )

  // Crear mapa
  const map = L.map('map').setView([10.33, -84.43], 12)

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map)

  // Icono del bus
  const busIcon = L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/61/61231.png',
    iconSize: [40, 40],
    iconAnchor: [20, 20]
  })

  let busMarker = L.marker([10.33, -84.43], { icon: busIcon }).addTo(map)

  // ============================
  // ðŸ”µ PEGA TU LINESTRING AQUÃ
  // ============================

  const routeGeoJSON = {
    "type": "Feature",
    "geometry": {
      "type": "LineString",
      "coordinates": [
          [
            -84.43506854609865,
            10.332746895648071
          ],
          [
            -84.43525598565407,
            10.333522576412363
          ],
          [
            -84.4351541163308,
            10.333648849843371
          ],
          [
            -84.43489333086227,
            10.33369895833465
          ],
          [
            -84.43455512470774,
            10.333769110207243
          ],
          [
            -84.43457535515624,
            10.333843044943919
          ],
          [
            -84.43451107381144,
            10.334694094507498
          ],
          [
            -84.43474678169714,
            10.335619482182523
          ],
          [
            -84.4347961463458,
            10.336028071871965
          ],
          [
            -84.43476899231742,
            10.336397606805662
          ],
          [
            -84.43122471251903,
            10.336022699336922
          ],
          [
            -84.43052682884574,
            10.333280381987322
          ],
          [
            -84.43017305503808,
            10.331758574068388
          ],
          [
            -84.4289624379198,
            10.33204129443412
          ],
          [
            -84.4286479037532,
            10.332161506166088
          ],
          [
            -84.42800299556875,
            10.332328466829239
          ],
          [
            -84.42774925453985,
            10.33240728059073
          ],
          [
            -84.42706603248371,
            10.329842258877378
          ],
          [
            -84.42699514407026,
            10.329059643269915
          ],
          [
            -84.42594430067598,
            10.324910482984933
          ],
          [
            -84.42593271380107,
            10.324874770483106
          ],
          [
            -84.42516198663573,
            10.324983326436893
          ],
          [
            -84.42384561106914,
            10.32545650808359
          ],
          [
            -84.42336944187453,
            10.32601682320086
          ],
          [
            -84.42300016808075,
            10.326294516861168
          ],
          [
            -84.42216291419994,
            10.326730128653097
          ],
          [
            -84.42176821671853,
            10.32727122883854
          ],
          [
            -84.42156019211522,
            10.327641309700454
          ],
          [
            -84.41989744887123,
            10.329448946090181
          ],
          [
            -84.41963970117374,
            10.329589214262853
          ],
          [
            -84.41797745089109,
            10.330302928749902
          ],
          [
            -84.41772122966523,
            10.330474718179403
          ],
          [
            -84.41758079347892,
            10.330704984240157
          ],
          [
            -84.41758467750854,
            10.331308824658919
          ],
          [
            -84.41702073488095,
            10.332143886628998
          ],
          [
            -84.41694202869694,
            10.332348664652017
          ],
          [
            -84.41707014173126,
            10.332882135548772
          ],
          [
            -84.41720850299683,
            10.333325812496426
          ],
          [
            -84.41713483575681,
            10.333787325752539
          ],
          [
            -84.41702773364605,
            10.334051389869956
          ],
          [
            -84.4156151568024,
            10.336576789491147
          ],
          [
            -84.41507384421357,
            10.33797495493414
          ],
          [
            -84.41474890303502,
            10.338929180902483
          ],
          [
            -84.41474517293301,
            10.339155524808618
          ],
          [
            -84.41512708325008,
            10.340871665200453
          ],
          [
            -84.41514648269961,
            10.341205394018544
          ],
          [
            -84.41504463546427,
            10.34145826158148
          ],
          [
            -84.41491368901939,
            10.341761225280024
          ],
          [
            -84.41465017575833,
            10.342118594775016
          ],
          [
            -84.41351152761595,
            10.343380296470883
          ],
          [
            -84.41334663209264,
            10.343504343875537
          ],
          [
            -84.4131477874916,
            10.343566367559092
          ],
          [
            -84.4125280568922,
            10.343589189606618
          ],
          [
            -84.41232012677109,
            10.343716114220939
          ],
          [
            -84.41212613203821,
            10.343890257492376
          ],
          [
            -84.41189080971756,
            10.344126449712178
          ],
          [
            -84.41174288873306,
            10.344240954737984
          ],
          [
            -84.4115731433416,
            10.344279123070649
          ],
          [
            -84.41127245150525,
            10.344288665153442
          ],
          [
            -84.41089606364807,
            10.344193716866926
          ],
          [
            -84.4105711224703,
            10.344007646150615
          ],
          [
            -84.40997246241295,
            10.343766182604824
          ],
          [
            -84.40981241675853,
            10.343575340583357
          ],
          [
            -84.40969844485245,
            10.343374956335452
          ],
          [
            -84.4095165747903,
            10.343193656191431
          ],
          [
            -84.40929590578078,
            10.343114933727762
          ],
          [
            -84.40893701552457,
            10.343179343017525
          ],
          [
            -84.40873789521105,
            10.34328795618444
          ],
          [
            -84.4086287731739,
            10.343471641800349
          ],
          [
            -84.40852692593857,
            10.344084721586526
          ],
          [
            -84.40850553754518,
            10.344737810050503
          ],
          [
            -84.40838914070545,
            10.344885712079773
          ],
          [
            -84.4081902961037,
            10.34497636167626
          ],
          [
            -84.40801085097593,
            10.344909567239824
          ],
          [
            -84.40678630540651,
            10.34348249907083
          ],
          [
            -84.40657753124889,
            10.3434320424616
          ],
          [
            -84.40637626171265,
            10.343510764845746
          ],
          [
            -84.40609496934958,
            10.34375408845311
          ],
          [
            -84.40593977356329,
            10.343775558174372
          ],
          [
            -84.40576032832752,
            10.343725462154026
          ],
          [
            -84.40482080547623,
            10.343204961586423
          ],
          [
            -84.4046245448693,
            10.343198054177563
          ],
          [
            -84.40444994960973,
            10.343293475318262
          ],
          [
            -84.40334853760578,
            10.34465986366034
          ],
          [
            -84.40323699063416,
            10.344881716733624
          ],
          [
            -84.40325396517302,
            10.345063015902653
          ],
          [
            -84.40342670451278,
            10.345794882835051
          ],
          [
            -84.40343493199472,
            10.345968785052918
          ],
          [
            -84.40337673357485,
            10.346090445927473
          ],
          [
            -84.4032312375248,
            10.346162011125884
          ],
          [
            -84.40307361680405,
            10.34607613288567
          ],
          [
            -84.40242369796609,
            10.345626261462854
          ],
          [
            -84.40222485336429,
            10.34556662369667
          ],
          [
            -84.40209633179492,
            10.34555708163498
          ],
          [
            -84.40191931160089,
            10.345652502057789
          ],
          [
            -84.40183201397149,
            10.34578609060101
          ],
          [
            -84.40178836515601,
            10.34600078635549
          ],
          [
            -84.4017447163413,
            10.346735521825352
          ],
          [
            -84.40162262033702,
            10.347192403598783
          ],
          [
            -84.40151349829985,
            10.34730929300396
          ],
          [
            -84.40129040435666,
            10.347411869384715
          ],
          [
            -84.40047943293311,
            10.347829640761873
          ],
          [
            -84.40039291076607,
            10.347949443758537
          ],
          [
            -84.40039291076607,
            10.348090187799926
          ],
          [
            -84.40073240154899,
            10.348469480747994
          ],
          [
            -84.40073725141713,
            10.348588755164826
          ],
          [
            -84.40068390286538,
            10.348746197326449
          ],
          [
            -84.39999717719775,
            10.349376751304789
          ],
          [
            -84.3995624517704,
            10.349600434961559
          ],
          [
            -84.39886649566493,
            10.349817513584355
          ],
          [
            -84.39841849957139,
            10.350053555487008
          ],
          [
            -84.39832523415977,
            10.350258223675809
          ],
          [
            -84.39830407694062,
            10.350665781015053
          ],
          [
            -84.39822516005621,
            10.35088879831973
          ],
          [
            -84.39747602930407,
            10.351756771414784
          ],
          [
            -84.39723327559338,
            10.351801779347554
          ],
          [
            -84.39699939464583,
            10.351691682537108
          ],
          [
            -84.39688317159766,
            10.35147854629507
          ],
          [
            -84.39679851530374,
            10.351014162855563
          ],
          [
            -84.39668107970279,
            10.350918696298919
          ],
          [
            -84.39588904115529,
            10.350953983829783
          ],
          [
            -84.39572048565877,
            10.351034038513433
          ],
          [
            -84.39557496619602,
            10.351176189110063
          ],
          [
            -84.39537695655916,
            10.351602461861162
          ],
          [
            -84.39522270286824,
            10.351980918859951
          ],
          [
            -84.39524332701835,
            10.352404377725179
          ],
          [
            -84.39537812971507,
            10.352939111591041
          ],
          [
            -84.39535230237085,
            10.353052030946472
          ],
          [
            -84.39515572758658,
            10.353196003065733
          ],
          [
            -84.39502228669193,
            10.35318894544369
          ],
          [
            -84.39471835323184,
            10.352950074920145
          ],
          [
            -84.39456891015357,
            10.352976674879642
          ],
          [
            -84.39443690372897,
            10.353074067814376
          ],
          [
            -84.39434794287767,
            10.353290025953811
          ],
          [
            -84.3943643402492,
            10.35406539521695
          ],
          [
            -84.3942799477688,
            10.354197124174547
          ],
          [
            -84.3937077113966,
            10.354594347289549
          ],
          [
            -84.39354841389301,
            10.354655287424052
          ],
          [
            -84.39301388226811,
            10.355071421173207
          ],
          [
            -84.39291266080689,
            10.3552114039462
          ],
          [
            -84.39292682058499,
            10.355425564518399
          ],
          [
            -84.39301531919861,
            10.35574245225233
          ],
          [
            -84.39296490306629,
            10.35596568718374
          ],
          [
            -84.3928073755346,
            10.356221634551332
          ],
          [
            -84.39255249952807,
            10.356477581711104
          ],
          [
            -84.39172953288586,
            10.35707204022485
          ],
          [
            -84.39155236235038,
            10.357293291118651
          ],
          [
            -84.39147273827807,
            10.35758749354953
          ],
          [
            -84.391424187015,
            10.358023065471997
          ],
          [
            -84.39144624345114,
            10.358284310992133
          ],
          [
            -84.39163656440438,
            10.358779104265821
          ],
          [
            -84.39164821607682,
            10.359004096495283
          ],
          [
            -84.391566649962,
            10.359261999833024
          ],
          [
            -84.39127534238106,
            10.359810282514687
          ],
          [
            -84.39055049529291,
            10.360515043726366
          ],
          [
            -84.3846831203772,
            10.363704676866632
          ],
          [
            -84.38446327984394,
            10.363690706361353
          ],
          [
            -84.38433413062623,
            10.36355640454228
          ],
          [
            -84.38428247093974,
            10.362946600962132
          ],
          [
            -84.38417177161064,
            10.362754222205965
          ],
          [
            -84.38397251281845,
            10.362707034944819
          ],
          [
            -84.38320060693435,
            10.36279348335465
          ],
          [
            -84.38073908027094,
            10.363179469520233
          ],
          [
            -84.38033679361074,
            10.363337323391733
          ],
          [
            -84.37974639718912,
            10.363595037822535
          ],
          [
            -84.37951023862097,
            10.36385638181909
          ],
          [
            -84.37945857893388,
            10.364059649220366
          ],
          [
            -84.37854390545199,
            10.3649479253109
          ],
          [
            -84.37786749774462,
            10.36555321793844
          ],
          [
            -84.3776356625842,
            10.365891484125584
          ],
          [
            -84.37758513883436,
            10.365984084204513
          ],
          [
            -84.37637837239498,
            10.369397594488206
          ],
          [
            -84.37632358087897,
            10.369956229166519
          ],
          [
            -84.37659071267018,
            10.372371453345409
          ],
          [
            -84.3765796400319,
            10.372551400227664
          ],
          [
            -84.37536358830121,
            10.376024339748213
          ],
          [
            -84.37535222282936,
            10.376404510574545
          ],
          [
            -84.3753806411048,
            10.378456291884461
          ],
          [
            -84.37511310642125,
            10.379421071428979
          ],
          [
            -84.37502216793922,
            10.379689422474684
          ],
          [
            -84.37459021014867,
            10.38006958606293
          ],
          [
            -84.37246526204869,
            10.381211769337156
          ],
          [
            -84.37213008337659,
            10.381340243629552
          ],
          [
            -84.37164244523285,
            10.38137332332471
          ],
          [
            -84.37110436176384,
            10.381336935659462
          ],
          [
            -84.36653110511892,
            10.379706978323142
          ],
          [
            -84.36614099460415,
            10.37961766266163
          ],
          [
            -84.36055733847539,
            10.378853229808229
          ],
          [
            -84.35870431431826,
            10.378546616440488
          ],
          [
            -84.35785574791235,
            10.378248500166706
          ],
          [
            -84.3533798150813,
            10.376176594501672
          ],
          [
            -84.35236751353092,
            10.376099998582504
          ],
          [
            -84.35157324616024,
            10.376031062240088
          ],
          [
            -84.3500588304598,
            10.37566180098952
          ],
          [
            -84.34640740016395,
            10.375305550565116
          ],
          [
            -84.34522106989681,
            10.3751898266747
          ],
          [
            -84.34517957373006,
            10.375466788633958
          ],
          [
            -84.3448687709447,
            10.375818367297228
          ],
          [
            -84.34239270875358,
            10.377805543620084
          ],
          [
            -84.34027878390322,
            10.37955493084894
          ],
          [
            -84.3396778985178,
            10.38052303240498
          ],
          [
            -84.33952374988516,
            10.381976682219644
          ],
          [
            -84.33956830592358,
            10.384523896388473
          ],
          [
            -84.33955853269852,
            10.386391008342756
          ],
          [
            -84.33907032562982,
            10.388941161195376
          ],
          [
            -84.33885112455793,
            10.389992191313553
          ],
          [
            -84.33843901916325,
            10.391955285755515
          ],
          [
            -84.3383402718383,
            10.392801423527516
          ],
          [
            -84.33819012187253,
            10.395139506664393
          ],
          [
            -84.33805020134939,
            10.396118333527923
          ],
          [
            -84.33788229908872,
            10.397402799200123
          ],
          [
            -84.3376918923519,
            10.398959798878778
          ],
          [
            -84.3374827480023,
            10.401511910456946
          ],
          [
            -84.33725262530626,
            10.403520913038392
          ],
          [
            -84.33706312205018,
            10.404231468720766
          ],
          [
            -84.33685747337032,
            10.404960596616817
          ],
          [
            -84.33648909090114,
            10.405794438712903
          ],
          [
            -84.3359995963871,
            10.406638205232525
          ],
          [
            -84.33548991653237,
            10.407357886636817
          ],
          [
            -84.33496509767181,
            10.40791874064854
          ],
          [
            -84.3334894855872,
            10.409559381763856
          ],
          [
            -84.33197053869324,
            10.411182369863695
          ],
          [
            -84.32938074642199,
            10.414018339565203
          ],
          [
            -84.32728533884314,
            10.416295569098267
          ],
          [
            -84.32092189238502,
            10.423155137413232
          ],
          [
            -84.31305201248719,
            10.431424840848507
          ],
          [
            -84.31025822797564,
            10.43441282912012
          ],
          [
            -84.30962056449135,
            10.434865747606565
          ],
          [
            -84.30913168915343,
            10.434907555432972
          ],
          [
            -84.30813268302785,
            10.43467064433861
          ],
          [
            -84.3077288294877,
            10.434733356117135
          ],
          [
            -84.3074950195436,
            10.43496329919347
          ],
          [
            -84.30736748684694,
            10.435290793586361
          ],
          [
            -84.30733206109761,
            10.43587610185405
          ],
          [
            -84.30716201750153,
            10.436140883803901
          ],
          [
            -84.3069636333068,
            10.43630114645346
          ],
          [
            -84.30636139557127,
            10.436384761715942
          ],
          [
            -84.30558911424029,
            10.436315082331575
          ],
          [
            -84.30322677848135,
            10.43538066123294
          ],
          [
            -84.29961130021229,
            10.435192527633276
          ],
          [
            -84.29403080365125,
            10.434997899788115
          ],
          [
            -84.29366671653216,
            10.435069354903334
          ],
          [
            -84.29334048371493,
            10.4352210233546
          ],
          [
            -84.2907424841854,
            10.437571874890565
          ],
          [
            -84.28824361840383,
            10.43990506580495
          ],
          [
            -84.28672522557505,
            10.441290174590918
          ],
          [
            -84.28615621438101,
            10.441781023798157
          ],
          [
            -84.28576529548448,
            10.442465815900675
          ],
          [
            -84.28505675498394,
            10.44461629357258
          ],
          [
            -84.28475972778011,
            10.445081474623237
          ],
          [
            -84.28212102521557,
            10.447568317595795
          ],
          [
            -84.28181673534424,
            10.447748712157605
          ],
          [
            -84.28127159377048,
            10.44795453754088
          ],
          [
            -84.28063699239583,
            10.448173870749471
          ],
          [
            -84.28031574825467,
            10.448264816741556
          ],
          [
            -84.27968299464285,
            10.448355762706953
          ],
          [
            -84.27759142580238,
            10.448301140705865
          ],
          [
            -84.2767573048516,
            10.448394682572456
          ],
          [
            -84.27554270767786,
            10.449035083828477
          ],
          [
            -84.27475745148213,
            10.449670460861157
          ],
          [
            -84.27354688451129,
            10.450796247561286
          ],
          [
            -84.27338769254226,
            10.451781525675017
          ],
          [
            -84.27312452580942,
            10.454071899443889
          ],
          [
            -84.27303362827212,
            10.45469528432804
          ],
          [
            -84.27295966322353,
            10.45535374609203
          ],
          [
            -84.27298691350407,
            10.455468593929908
          ],
          [
            -84.27300637799095,
            10.455552815651629
          ],
          [
            -84.27232901386157,
            10.455495391753573
          ],
          [
            -84.2723445854507,
            10.456050488994563
          ]
        ],
    }
  }

  const routeLayer = L.geoJSON(routeGeoJSON, {
    style: {
      color: "#2563eb",
      weight: 5
    }
  }).addTo(map)

  map.fitBounds(routeLayer.getBounds())

  // ============================
  // ðŸš€ TIEMPO REAL
  // ============================

  supabaseClient
    .channel('realtime-locations')
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'locations'
      },
      (payload) => {
        const { lat, lng, created_at } = payload.new

        busMarker.setLatLng([lat, lng])
        map.panTo([lat, lng], { animate: true, duration: 0.5 })

        // Actualizar panel lateral
        document.getElementById("lat").innerText = lat
        document.getElementById("lng").innerText = lng
        document.getElementById("time").innerText = new Date(created_at).toLocaleTimeString()
        document.getElementById("status").innerText = "En ruta"
      }
    )
    .subscribe()

</script>

</body>
</html>
